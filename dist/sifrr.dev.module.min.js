/*! sifrr.dev v0.0.16 - sifrr project | MIT licensed | https://github.com/sifrr/sifrr-dev */
import e from"fs";import r from"path";import t from"rollup-plugin-babel";import o from"rollup-plugin-terser";import s from"rollup-plugin-node-resolve";import n from"rollup-plugin-commonjs";import i from"rollup-plugin-cleanup";import a from"rollup-plugin-postcss";import c from"rollup-plugin-html";import l from"rollup-plugin-typescript2";import p from"rollup-plugin-replace";import u from"typescript";import m from"cssnano";import f from"autoprefixer";import d from"conventional-changelog";import g from"child_process";import w from"mocha";import h from"json-fn";import y from"chai";import v from"sinon";import b from"crypto";import j from"puppeteer";import S from"chai-as-promised";import x from"istanbul-lib-coverage";import _ from"istanbul-lib-source-maps";import E from"istanbul-lib-instrument";import F from"istanbul-api";import T from"inspector";import $ from"ts-node";import N from"portfinder";import P from"@sifrr/server";var O=function t({dir:o,onFile:s=(()=>{}),onDir:n=(()=>{}),deep:i=100}={}){return!(!e.existsSync(o)||!e.statSync(o).isDirectory()||(e.readdirSync(o).forEach(a=>{const c=r.join(o,a);e.statSync(c).isDirectory()?n(c):s(c),i>0&&t({dir:c,onFile:s,onDir:n,deep:i-1})}),0))};var k=function e(r,t,o=!1){switch(null===(s=r)?"null":"object"==typeof s&&Array.isArray(s)?"array":typeof s){case"array":return o?[...r,...t]:[...t];case"object":return Object.keys(t).forEach(s=>{r[s]=e(r[s],t[s],o)}),r;default:return void 0===t?r:t}var s},C="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function A(){throw new Error("Dynamic requires are not currently supported by rollup-plugin-commonjs")}const D=o.terser;var R=function({name:o,inputFile:d,outputFolder:g,minify:w=!1,type:h="cjs",outputFileName:y,replaceEnv:v=!0},b={}){const j=r.basename(d).slice(0,r.basename(d).lastIndexOf(".")).toLowerCase(),S=(h=Array.isArray(h)?h:[h]).map(e=>{const t="cjs"===e?"cjs":"browser"===e?"iife":"es";return{file:r.join(g,`./${y||j}${"es"===t?".module":"cjs"===t?".cjs":""}${w?".min":""}.js`),format:t,name:o,sourcemap:!w,preferConst:!0,...b.output}}),x={input:d,output:1===S.length?S[0]:S,external:Object.keys(A(r.resolve("./package.json")).dependencies||[]).concat(),plugins:[s({browser:"browser"===h,mainFields:["module","main"]}),!!v&&p({ENVIRONMENT:JSON.stringify(process.env.NODE_ENV||process.env.ENV||"development"),"global.IS_NODE":JSON.stringify("cjs"===h[0]),"global.IS_MODULE":JSON.stringify("module"===h[0]),"global.IS_BROWSER":JSON.stringify("browser"===h[0])}),!!e.existsSync(r.resolve("tsconfig.json"))&&l({typescript:u,declarationDir:"dist/type",cacheRoot:"./.ts_cache"}),n(),a({extensions:[".css",".scss",".sass",".less"],inject:!1,plugins:[!!w&&m({preset:["default"]}),f].filter(e=>e)}),c({htmlMinifierOptions:w?{collapseWhitespace:!0,collapseBooleanAttributes:!0,conservativeCollapse:!0,minifyJS:!0}:{}}),i(),t({exclude:"node_modules/**",rootMode:"upward"}),!!w&&D({output:{comments:"all"}})].filter(e=>e)};return delete b.output,k(x,b,!0)};const M=/tag:\s*[v=]?(.+?)[,)]/gi;const J=g.spawn,I=g.exec,W=/((?:["'][^"]+["'])|(?:[^ ]+))/;var H=function(e,r={}){return 0===e.indexOf("sh ")||r.spawn?(process.stdout.write(`Running command: ${e} with spawn \n`),r.stdio=r.stdio||"inherit",new Promise((t,o)=>{const[s,...n]=e.split(W).filter(e=>""!==e.trim());J(s,n,r).on("close",r=>{0!==r?(process.stdout.write(`Command exited with code ${r}: ${e} \n`),o(r)):(process.stdout.write(`Finished command: ${e} \n`),t())})})):(process.stdout.write(`Running command: ${e} \n`),new Promise((t,o)=>{I(e,r,(r,s,n)=>{s&&process.stdout.write(`out: ${s} \n`),n&&process.stderr.write(`err: ${n} \n`),null!==r&&(process.stderr.write(`exec error: ${r}`),o(r)),t({stdout:s,stderr:n}),process.stdout.write(`Finished command: ${e} \n`)})}))};var V=async function(e,t="v"){const o=t+(e=e||A(r.resolve("./package.json")).version);return await H("git pull"),H(`git rev-parse ${o}`).then(()=>(process.stdout.write(`Tag ${o} already exists.\n`),!0)).catch(()=>!1)};var G=async function(e,t="v"){const o=t+(e=e||A(r.resolve("./package.json")).version);return!await V(e,t)&&(await H(`git tag -a ${o} -m "Release of ${o}"`),process.stdout.write("\n"),await H(`git push origin ${o}`),!0)},L=parseInt("0777",8),U=B.mkdirp=B.mkdirP=B;function B(t,o,s,n){"function"==typeof o?(s=o,o={}):o&&"object"==typeof o||(o={mode:o});var i=o.mode,a=o.fs||e;void 0===i&&(i=L&~process.umask()),n||(n=null);var c=s||function(){};t=r.resolve(t),a.mkdir(t,i,function(e){if(!e)return c(null,n=n||t);switch(e.code){case"ENOENT":B(r.dirname(t),o,function(e,r){e?c(e,r):B(t,o,c,r)});break;default:a.stat(t,function(r,t){r||!t.isDirectory()?c(e,n):c(null,n)})}})}B.sync=function t(o,s,n){s&&"object"==typeof s||(s={mode:s});var i=s.mode,a=s.fs||e;void 0===i&&(i=L&~process.umask()),n||(n=null),o=r.resolve(o);try{a.mkdirSync(o,i),n=n||o}catch(e){switch(e.code){case"ENOENT":n=t(r.dirname(o),s,n),t(o,s,n);break;default:var c;try{c=a.statSync(o)}catch(r){throw e}if(!c.isDirectory())throw e}}return n};var X=function(t,o,s=""){const n=r.join(o,`${Date.now()}-${s}-${b.randomBytes(10).toString("hex")}.json`);U.sync(r.dirname(n),e=>{if(e)throw e});const i=JSON.stringify(t||{});"{}"!==i&&e.writeFileSync(n,i)};async function q(e,r){const t=await e.evaluate(()=>window.__coverage__);X(t,r,"browser-coverage")}var z=async function(e,r,t){let o;C.browser?o=C.browser:(o=C.browser="string"==typeof t?await j.connect({browserWSEndpoint:t,ignoreHTTPSErrors:!0}):await j.launch({args:["--no-sandbox","--disable-setuid-sandbox"],ignoreHTTPSErrors:!0,headless:"false"!==process.env.HEADLESS,devtools:!1}),e&&r&&(o.__newPage=o.newPage,o.newPage=async()=>{const e=await o.__newPage();return function(e,r){e.goto=async(t,o)=>(await q(e,r),e.mainFrame().goto(t,o)),e._close=e.close,e.close=async()=>(await q(e,r),e._close())}(e,r),e},o.__close=o.close,o.close=async()=>{const e=await o.pages();for(let r=0;r<e.length;r++)await e[r].close();return o.__close()}));const s=await o.newPage();return await s.setViewport({width:1280,height:800}),C.page||(C.page=s),{browser:o,page:s}};const{fork:K}=g;var Q=async function(e,t=!0){const o=[];let s=0;t&&await z();for(let n=0;n<e.length;n++){const i=e[n];i.browserWSEndpoint=t?C.browser.wsEndpoint():i.browserWSEndpoint;const a=K(r.join(__dirname,"./run"),process.argv);o.push(new Promise(e=>{a.on("exit",r=>{r&&r>0&&C.console.log("[36m%s[0m",`Config#${n}: tests from ${i.root} exited with code ${r}`),e()}),a.on("message",e=>{s+=Number(e)}),a.on("error",e=>{C.console.error(e)}),a.send(h.stringify(i))}))}if(await Promise.all(o),t&&await C.browser.close(),s>0)throw s;return 0};function Y(){try{let e,r,t=new Error;for(Error.prepareStackTrace=function(e,r){return r},r=t.stack.shift().getFileName();t.stack.length;)if(r!==(e=t.stack.shift().getFileName()))return e}catch(e){}}var Z=(e,t)=>{C.__pdescribes=[],C.ENV=process.env.NODE_ENV=process.env.NODE_ENV||"test",C.Mocha=w,C.chai=y,C.sinon=C.sinon||v.createSandbox(),C.assert=chai.assert,C.expect=chai.expect,C.should=chai.should(),C.delay=e=>new Promise(r=>{setTimeout(function(){r()},e)}),C.pdescribe=function(o,s){const n=Y();if(n&&e&&!e.parallel&&t){const t=k({},e);k(t,{browserWSEndpoint:C.browser?C.browser.wsEndpoint():void 0,filters:[n],parallel:!0,junitXmlFile:r.join(e.junitXmlFile,`../../${r.basename(Y()).replace(".test.js","")}/results.xml`),port:"random"}),C.__pdescribes.push(Q([t],!0).catch(e=>e))}else describe(o,s)},chai.use(S)};const{createInstrumenter:ee}=E,re=F.createReporter(),te=ee({esModules:!0});var oe=function(r,t,o,s=["html"]){const n=_.createSourceMapStore({});let i=x.createCoverageMap();e.existsSync(r)&&(O({dir:r,onFile:r=>{r.match(/browser/)&&i.merge(JSON.parse(e.readFileSync(r)))}}),i=n.transformCoverage(i).map,O({dir:r,onFile:r=>{r.match(/unit/)&&i.merge(JSON.parse(e.readFileSync(r)))}}),O({dir:t,onFile:r=>{if(".js"===r.slice(-3)&&r.match(o)&&!i.data[r]){const t=e.readFileSync(r).toString();te.instrumentSync(t,r);const o={};o[r]=te.fileCoverage,i.merge(o)}}}),i.filter(e=>e.match(o)),s.forEach(e=>re.add(e)),re.write(i))},se=async function(){const e=await N.getPortPromise({port:1e4});return[e,await N.getPortPromise({port:e+1})]};const ne=E.createInstrumenter(),{App:ie,SSLApp:ae}=P;function ce(t,o,s=!1){O({dir:o,onFile:n=>{s&&".js"===n.slice(-3)&&e.existsSync(n+".map")?t.get("/"+r.relative(o,n),r=>{r.onAborted(C.console.log);const t=e.readFileSync(n,"utf-8");r.writeHeader("content-type","application/javascript; charset=UTF-8"),r.end(ne.instrumentSync(t,n,JSON.parse(e.readFileSync(n+".map"))))}):t.file("/"+r.relative(o,n),n)}})}var le=async function(t,{extraStaticFolders:o=[],setGlobals:s=!0,coverage:n=!0,port:i=!1,securePort:a=!1}={}){const c=[];function l(e,s,i){ce(e,t,n),ce(e,r.join(t,"../../dist"),n),o.forEach(r=>{ce(e,r,n)}),c.push([e,s,i])}let p,u;if(i){let o;"function"==typeof(o=e.existsSync(r.join(t,"server.js"))?A(r.join(t,"server.js")):new ie).file?l(o,i,!1):c.push([o,i,!1]),p=o}if(a){let o;"function"==typeof(o=e.existsSync(r.join(t,"secureserver.js"))?A(r.join(t,"secureserver.js")):new ae({key_file_name:r.join(__dirname,"keys/server.key"),cert_file_name:r.join(__dirname,"keys/server.crt")})).file?l(o,a,!0):c.push([o,a,!0]),u=o}return{secureApp:u,app:p,listen:async()=>{for(let e=0;e<c.length;e++){let[r,o,n]=c[e];"random"===o&&(o=(await se())[0]),s&&o&&(C[n?"SPATH":"PATH"]=`http${n?"s":""}://localhost:${o}`,C[n?"securePort":"port"]=o),r.listen(o,e=>{e?C.console.log(`Test server listening on port ${o}, serving ${t}`):C.console.log("Test server failed to listen to port "+o)})}},close:()=>{u&&u.close&&u.close(),p&&p.close&&p.close()}}};function pe(e,r,t,o){O({dir:e,onFile:e=>{o.map(r=>e.indexOf(r)>=0).indexOf(!0)>=0&&e.match(t)&&r.addFile(e)}})}async function ue(e){if(e)if(Array.isArray(e))for(let r=0;r<e.length;r++)await H(e[r]).catch(C.console.error);else await H(e).catch(C.console.error)}async function me(t={},o=!1,s){if(Array.isArray(t)){for(let e=0;e<t.length;e++)await ue(t[e].preCommand),delete t[e].preCommand;if(o)return Q(t,s);{let e=0;for(let r=0;r<t.length;r++)e+=await me(t[r]).catch(e=>Number(e)?Number(e):(process.stderr.write(e+"\n"),0));if(e>0)throw e;return 0}}const{root:n=r.resolve("./"),serverOnly:i=!1,runUnitTests:a=!0,runBrowserTests:c=!0,coverage:l=!1,setGlobals:p=!0,testFileRegex:u=/\.test\.js$/,sourceFileRegex:m=/\.js$/,filters:f=[""],folders:d={},preCommand:g=!1,port:h="random",securePort:y=!1,useJunitReporter:v=!1,junitXmlFile:b=r.join(n,`./test-results/${r.basename(n)}/results.xml`),inspect:j=!1,reporters:S=["html"],mochaOptions:x={},before:_,browserWSEndpoint:E}=t;j&&T.open(void 0,void 0,!0);const F="function"==typeof _&&_();F instanceof Promise&&await F;const N=k({unitTest:r.join(n,"./test/unit"),browserTest:r.join(n,"./test/browser"),public:r.join(n,"./test/public"),static:[],coverage:r.join(n,"./.nyc_output"),source:r.join(n,"./src")},d,!0);e.existsSync(r.join(n,"tsconfig.json"))&&$.register({}),await ue(g);const P=await le(N.public,{extraStaticFolders:N.static,setGlobals:p,coverage:l,port:h,securePort:y});if(i)return await P.listen(),"server";p&&Z(t,o),v&&(x.reporter="mocha-junit-reporter",x.reporterOptions={mochaFile:b});const O=new w(x);return!c&&a||!e.existsSync(N.browserTest)||(await P.listen(),await z(l,N.coverage,E),pe(N.browserTest,O,u,f)),!a&&c||!e.existsSync(N.unitTest)||pe(N.unitTest,O,u,f),new Promise((e,r)=>{O.run(async t=>{if(P.close(),C.browser&&!E&&(await browser.close(),delete C.browser,delete C.page),C.__pdescribes){t+=(await Promise.all(C.__pdescribes)).reduce((e,r)=>e+r,0)}l&&(X(C.__coverage__,N.coverage,"unit-coverage"),oe(N.coverage,N.source,m,S)),t?r(t):e(0)})})}process.on("message",async e=>{e=h.parse(e),await me(e,!0).catch(e=>{Number(e)?process.send(`${e}`):process.stderr.write(e+"\n")}).then(e=>{"server"!==e&&process.exit()})});var fe={loadDir:O,deepMerge:k,getRollupConfig:R,generateChangelog:({folder:t=r.resolve("./"),releaseCount:o=0,changelogFile:s=r.join(t,"./CHANGELOG.md"),outputUnreleased:n=!1,multiRepo:i=!1}={})=>{let a="",c=!1,l=A(r.join(t,"./package.json")).version;const p=function(e,r){n&&!c&&(e.version=l,c=!0);let t=M.exec(e.gitTags);M.lastIndex=0,t&&(e.version=t[1]),r(null,e)},u={pkg:{path:r.join(t,"./package.json")},preset:"angular",releaseCount:o,outputUnreleased:n,gitRawCommitsOpts:{path:t},transform:p};return e.existsSync(s)&&(0===o&&e.writeFileSync(s,""),a=e.readFileSync(s,"utf-8")),i&&(u.transform=(e,r)=>{e.scope&&e.scope===i?e.scope=null:e.type="chore",p(e,r)}),new Promise((r,t)=>{d(u).pipe(e.createWriteStream(s)).on("error",t).on("finish",()=>{e.appendFileSync(s,a),r(s)})})},exec:H,checkTag:V,releaseTag:G,gitAddCommitPush:async function({preCommand:e=!1,files:r="*",commitMsg:t="chore: add new files",push:o=!0}={}){if(e)if(Array.isArray(e))for(let r=0;r<e.length;r++)await H(e[r]);else await H(e);if(Array.isArray(r))for(let e=0;e<r.length;e++)await H(`git ls-files '${r[e]}' | xargs git add`);else await H(`git ls-files '${r}' | xargs git add`);await H(`git commit -m "${t}"`).then(()=>{o&&H("git push")}).catch(()=>{process.stdout.write("Nothing to commit, not running git push. \n")})},runTests:me,objectSelect:(e,r=[])=>{const t={};return r.forEach(r=>{e[r]&&(t[r]=e[r])}),t}},de=fe.loadDir,ge=fe.deepMerge,we=fe.getRollupConfig,he=fe.generateChangelog,ye=fe.exec,ve=fe.checkTag,be=fe.releaseTag,je=fe.gitAddCommitPush,Se=fe.runTests,xe=fe.objectSelect;export default fe;export{ve as checkTag,ge as deepMerge,ye as exec,he as generateChangelog,we as getRollupConfig,je as gitAddCommitPush,de as loadDir,xe as objectSelect,be as releaseTag,Se as runTests};
/*! (c) @aadityataparia */
