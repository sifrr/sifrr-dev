/*! sifrr.dev v0.0.9 - sifrr project | MIT licensed | https://github.com/sifrr/sifrr-dev */
"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});const fs=_interopDefault(require("fs")),path=_interopDefault(require("path")),rollupPluginBabel=_interopDefault(require("rollup-plugin-babel")),rollupPluginTerser=_interopDefault(require("rollup-plugin-terser")),rollupPluginNodeResolve=_interopDefault(require("rollup-plugin-node-resolve")),rollupPluginCommonjs=_interopDefault(require("rollup-plugin-commonjs")),rollupPluginCleanup=_interopDefault(require("rollup-plugin-cleanup")),rollupPluginPostcss=_interopDefault(require("rollup-plugin-postcss")),rollupPluginHtml=_interopDefault(require("rollup-plugin-html")),cssnano=_interopDefault(require("cssnano")),autoprefixer=_interopDefault(require("autoprefixer")),conventionalChangelog=_interopDefault(require("conventional-changelog")),child_process=_interopDefault(require("child_process")),mocha=_interopDefault(require("mocha")),jsonFn=_interopDefault(require("json-fn")),chai$1=_interopDefault(require("chai")),sinon=_interopDefault(require("sinon")),chaiAsPromised=_interopDefault(require("chai-as-promised")),crypto=_interopDefault(require("crypto")),puppeteer=_interopDefault(require("puppeteer")),istanbulLibCoverage=_interopDefault(require("istanbul-lib-coverage")),istanbulLibSourceMaps=_interopDefault(require("istanbul-lib-source-maps")),istanbulLibInstrument=_interopDefault(require("istanbul-lib-instrument")),istanbulApi=_interopDefault(require("istanbul-api")),inspector=_interopDefault(require("inspector")),istanbulLibHook=_interopDefault(require("istanbul-lib-hook")),portfinder=_interopDefault(require("portfinder")),server$1=_interopDefault(require("@sifrr/server"));var eslintrc={env:{browser:!0,node:!0,es6:!0,mocha:!0},globals:{ENV:!0,chai:!1,sinon:!1,assert:!1,expect:!1,should:!1,delay:!1,port:!1,PATH:!1,SPATH:!1,page:!1,browser:!1},extends:"eslint:recommended",parserOptions:{sourceType:"module",ecmaVersion:2017,esversion:2017},rules:{indent:["error",2],"linebreak-style":["error","unix"],quotes:["error","single",{avoidEscape:!0,allowTemplateLiterals:!0}],semi:["warn","always"],"quote-props":["error","as-needed"],"no-var":["error"],"max-lines":["error",220],"mocha/no-exclusive-tests":"error"},plugins:["html","mocha"],settings:{"html/indent":"+2"}};function loadDir({dir:e,onFile:r=(()=>{}),onDir:t=(()=>{}),deep:o=100}={}){return!(!fs.existsSync(e)||!fs.statSync(e).isDirectory())&&(fs.readdirSync(e).forEach(s=>{const n=path.join(e,s);fs.statSync(n).isDirectory()?t(n):r(n),o>0&&loadDir({dir:n,onFile:r,onDir:t,deep:o-1})}),!0)}var loaddir=loadDir;function type(e){return null===e?"null":"object"==typeof e&&Array.isArray(e)?"array":typeof e}function deepMerge(e,r,t=!1){switch(type(e)){case"array":return t?[...e,...r]:[...r];case"object":return Object.keys(r).forEach(o=>{e[o]=deepMerge(e[o],r[o],t)}),e;default:return void 0===r?e:r}}var deepmerge=deepMerge;const terser=rollupPluginTerser.terser;function moduleConfig({name:e,inputFile:r,outputFolder:t,minify:o=!1,type:s="cjs",outputFileName:n},i){const a=path.basename(r).slice(0,path.basename(r).lastIndexOf(".")).toLowerCase(),l="cjs"===s?"cjs":"browser"===s?"umd":"es",c={input:r,output:{file:path.join(t,`./${(n||a)+("module"===s?".module":"")+(o?".min":"")}.js`),format:l,name:e,sourcemap:!o,preferConst:!0},plugins:[rollupPluginNodeResolve({browser:"browser"===s,mainFields:["module","main"]}),rollupPluginCommonjs(),rollupPluginPostcss({extensions:[".css",".scss",".sass",".less"],inject:!1,plugins:[!!o&&cssnano({preset:["default"]}),autoprefixer].filter(e=>e)}),rollupPluginHtml({htmlMinifierOptions:o?{collapseWhitespace:!0,collapseBooleanAttributes:!0,conservativeCollapse:!0,minifyJS:!0}:{}})]};return"module"!==s&&c.plugins.push(rollupPluginBabel({exclude:"node_modules/**",rootMode:"upward"})),c.plugins.push(rollupPluginCleanup()),o&&c.plugins.push(terser({output:{comments:"all"}})),deepmerge(c,i,!0)}var getrollupconfig=moduleConfig,commonjsGlobal="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function commonjsRequire(){throw new Error("Dynamic requires are not currently supported by rollup-plugin-commonjs")}const rtag=/tag:\s*[v=]?(.+?)[,)]/gi;var generatechangelog=({folder:e=path.resolve("./"),releaseCount:r=0,changelogFile:t=path.join(e,"./CHANGELOG.md"),outputUnreleased:o=!1,multiRepo:s=!1}={})=>{let n="",i=!1,a=commonjsRequire(path.join(e,"./package.json")).version;const l=function(e,r){o&&!i&&(e.version=a,i=!0);let t=rtag.exec(e.gitTags);rtag.lastIndex=0,t&&(e.version=t[1]),r(null,e)},c={pkg:{path:path.join(e,"./package.json")},preset:"angular",releaseCount:r,outputUnreleased:o,gitRawCommitsOpts:{path:e},transform:l};return fs.existsSync(t)&&(0===r&&fs.writeFileSync(t,""),n=fs.readFileSync(t,"utf-8")),s&&(c.transform=(e,r)=>{e.scope&&e.scope===s?e.scope=null:e.type="chore",l(e,r)}),new Promise((e,r)=>{conventionalChangelog(c).pipe(fs.createWriteStream(t)).on("error",r).on("finish",()=>{fs.appendFileSync(t,n),e(t)})})};const spawn=child_process.spawn,execa=child_process.exec,splitRegex=/((?:["'][^"]+["'])|(?:[^ ]+))/;function exec(e,r={}){return 0===e.indexOf("sh ")||r.spawn?(process.stdout.write(`Running command: ${e} with spawn \n`),r.stdio=r.stdio||"inherit",new Promise((t,o)=>{const[s,...n]=e.split(splitRegex).filter(e=>""!==e.trim());spawn(s,n,r).on("close",r=>{0!==r?(process.stdout.write(`Command exited with code ${r}: ${e} \n`),o(r)):(process.stdout.write(`Finished command: ${e} \n`),t())})})):(process.stdout.write(`Running command: ${e} \n`),new Promise((t,o)=>{execa(e,r,(r,s,n)=>{s&&process.stdout.write(`out: ${s} \n`),n&&process.stderr.write(`err: ${n} \n`),null!==r&&(process.stderr.write(`exec error: ${r}`),o(r)),t({stdout:s,stderr:n}),process.stdout.write(`Finished command: ${e} \n`)})}))}var exec_1=exec;async function checkTag(e,r="v"){const t=r+(e=e||commonjsRequire(path.resolve("./package.json")).version);return await exec_1("git pull"),exec_1(`git rev-parse ${t}`).then(()=>(process.stdout.write(`Tag ${t} already exists.\n`),!0)).catch(()=>!1)}var checktag=checkTag;async function releaseTag(e,r="v"){const t=r+(e=e||commonjsRequire(path.resolve("./package.json")).version);return!await checktag(e,r)&&(await exec_1(`git tag -a ${t} -m "Release of ${t}"`),process.stdout.write("\n"),await exec_1(`git push origin ${t}`),!0)}var releasetag=releaseTag,gitaddcommitpush=async function({preCommand:e=!1,files:r="*",commitMsg:t="chore: add new files",push:o=!0}={}){if(e)if(Array.isArray(e))for(let r=0;r<e.length;r++)await exec_1(e[r]);else await exec_1(e);if(Array.isArray(r))for(let e=0;e<r.length;e++)await exec_1(`git ls-files '${r[e]}' | xargs git add`);else await exec_1(`git ls-files '${r}' | xargs git add`);await exec_1(`git commit -m "${t}"`).then(()=>{o&&exec_1("git push")}).catch(()=>{process.stdout.write("Nothing to commit, not running git push. \n")})};const{fork:fork}=child_process;var parallel=async function(e){const r=[];let t=0;for(let o=0;o<e.length;o++){const s=e[o];s.before=s.before?s.before.toString():"false";const n=fork(path.join(__dirname,"./run"),process.argv);r.push(new Promise(e=>{n.on("exit",r=>{r&&r>0&&commonjsGlobal.console.log("[36m%s[0m",`Config#${o}: tests from ${s.root} exited with code ${r}`),e()}),n.on("message",e=>{t+=Number(e)}),n.on("error",e=>{commonjsGlobal.console.error(e)}),n.send(jsonFn.stringify(s))}))}if(await Promise.all(r),t>0)throw t;return 0};function getCaller(){try{let e,r,t=new Error;for(Error.prepareStackTrace=function(e,r){return r},r=t.stack.shift().getFileName();t.stack.length;)if(r!==(e=t.stack.shift().getFileName()))return e}catch(e){}}var testglobals=e=>{commonjsGlobal.__tps=[Promise.resolve(0)],commonjsGlobal.ENV=process.env.NODE_ENV=process.env.NODE_ENV||"test",commonjsGlobal.Mocha=mocha,commonjsGlobal.chai=chai$1,commonjsGlobal.sinon=commonjsGlobal.sinon||sinon.createSandbox(),commonjsGlobal.assert=chai.assert,commonjsGlobal.expect=chai.expect,commonjsGlobal.should=chai.should(),commonjsGlobal.delay=e=>new Promise(r=>{setTimeout(function(){r()},e)}),commonjsGlobal.pdescribe=function(r,t){const o=getCaller();if(o&&e&&!e.parallel){const r=deepmerge({},e);deepmerge(r,{filters:[o],parallel:!0,port:"random"}),commonjsGlobal.__tps.push(parallel([r]))}else describe(r,t)},chai.use(chaiAsPromised)},_0777=parseInt("0777",8),mkdirp=mkdirP.mkdirp=mkdirP.mkdirP=mkdirP;function mkdirP(e,r,t,o){"function"==typeof r?(t=r,r={}):r&&"object"==typeof r||(r={mode:r});var s=r.mode,n=r.fs||fs;void 0===s&&(s=_0777&~process.umask()),o||(o=null);var i=t||function(){};e=path.resolve(e),n.mkdir(e,s,function(t){if(!t)return i(null,o=o||e);switch(t.code){case"ENOENT":mkdirP(path.dirname(e),r,function(t,o){t?i(t,o):mkdirP(e,r,i,o)});break;default:n.stat(e,function(e,r){e||!r.isDirectory()?i(t,o):i(null,o)})}})}function hash(){return crypto.randomBytes(10).toString("hex")}mkdirP.sync=function e(r,t,o){t&&"object"==typeof t||(t={mode:t});var s=t.mode,n=t.fs||fs;void 0===s&&(s=_0777&~process.umask()),o||(o=null),r=path.resolve(r);try{n.mkdirSync(r,s),o=o||r}catch(s){switch(s.code){case"ENOENT":o=e(path.dirname(r),t,o),e(r,t,o);break;default:var i;try{i=n.statSync(r)}catch(e){throw s}if(!i.isDirectory())throw s}}return o};var writecoverage=function(e,r,t=""){const o=path.join(r,`${Date.now()}-${t}-${hash()}.json`);mkdirp.sync(path.dirname(o),e=>{if(e)throw e});const s=JSON.stringify(e||{});"{}"!==s&&fs.writeFileSync(o,s)};async function writePageCoverage(e,r){const t=await e.evaluate(()=>window.__coverage__);writecoverage(t,r,"browser-coverage")}function setPageForCoverage(e,r){e.goto=async(t,o)=>{return await writePageCoverage(e,r),e.mainFrame().goto(t,o)},e._close=e.close,e.close=async()=>(await writePageCoverage(e,r),e._close())}var loadbrowser=async function(e,r,t=path.join(e,"./.nyc_output")){let o;commonjsGlobal.browser?o=commonjsGlobal.browser:(o=commonjsGlobal.browser=await puppeteer.launch({args:["--no-sandbox","--disable-setuid-sandbox"],ignoreHTTPSErrors:!0,headless:"false"!==process.env.HEADLESS,devtools:!1}),r&&(o.__newPage=o.newPage,o.newPage=async()=>{const e=await o.__newPage();return setPageForCoverage(e,t),e},o.__close=o.close,o.close=async()=>{const e=await o.pages();for(let r=0;r<e.length;r++)await e[r].close();return o.__close()}));const s=await o.newPage();return await s.setViewport({width:1280,height:800}),commonjsGlobal.page||(commonjsGlobal.page=s),{browser:o,page:s}};const{createInstrumenter:createInstrumenter}=istanbulLibInstrument,reporter=istanbulApi.createReporter(),instrumenter=createInstrumenter({esModules:!0});var transformcoverage=function(e,r,t,o=["html"]){const s=istanbulLibSourceMaps.createSourceMapStore({});let n=istanbulLibCoverage.createCoverageMap();fs.existsSync(e)&&(loaddir({dir:e,onFile:e=>{e.match(/browser/)&&n.merge(JSON.parse(fs.readFileSync(e)))}}),n=s.transformCoverage(n).map,loaddir({dir:e,onFile:e=>{e.match(/unit/)&&n.merge(JSON.parse(fs.readFileSync(e)))}}),loaddir({dir:r,onFile:e=>{if(".js"===e.slice(-3)&&e.match(t)&&!n.data[e]){const r=fs.readFileSync(e).toString();instrumenter.instrumentSync(r,e);const t={};t[e]=instrumenter.fileCoverage,n.merge(t)}}}),n.filter(e=>e.match(t)),o.forEach(e=>reporter.add(e)),reporter.write(n))},getports=async function(){const e=await portfinder.getPortPromise({port:1e4});return[e,await portfinder.getPortPromise({port:e+1})]};const instrumenter$1=istanbulLibInstrument.createInstrumenter(),{App:App,SSLApp:SSLApp}=server$1;function staticInstrument(e,r,t=!1){loaddir({dir:r,onFile:o=>{t&&".js"===o.slice(-3)?e.get("/"+path.relative(r,o),e=>{e.onAborted(commonjsGlobal.console.log);const r=fs.readFileSync(o,"utf-8");fs.existsSync(o+".map")?(e.writeHeader("content-type","application/javascript; charset=UTF-8"),e.end(instrumenter$1.instrumentSync(r,o,JSON.parse(fs.readFileSync(o+".map"))))):(e.writeHeader("content-type","application/javascript; charset=UTF-8"),e.end(r))}):e.file("/"+path.relative(r,o),o)}})}var server=async function(e,{extraStaticFolders:r=[],setGlobals:t=!0,coverage:o=!0,port:s=!1,securePort:n=!1}={}){const i=[];function a(t,s){staticInstrument(t,e,o),staticInstrument(t,path.join(e,"../../dist"),o),r.forEach(e=>{staticInstrument(t,e,o)}),i.push(t.listen.bind(t,s,r=>{r?commonjsGlobal.console.log(`Test server listening on port ${s}, serving ${e}`):commonjsGlobal.console.log("Test server failed to listen to port "+s)}))}let l,c;const u=await getports();if(s){let r;"random"===s&&(s=u[0]),"function"==typeof(r=fs.existsSync(path.join(e,"server.js"))?commonjsRequire(path.join(e,"server.js")):new App).file?a(r,s):i.push(r.listen.bind(r,s)),l=r}if(t&&s&&(commonjsGlobal.PATH=`http://localhost:${s}`,commonjsGlobal.port=s),n){let r;"random"===n&&(n=u[1]),"function"==typeof(r=fs.existsSync(path.join(e,"secureserver.js"))?commonjsRequire(path.join(e,"secureserver.js")):new SSLApp({key_file_name:path.join(__dirname,"keys/server.key"),cert_file_name:path.join(__dirname,"keys/server.crt")})).file?a(r,n):i.push(r.listen.bind(r,n)),c=r}return t&&n&&(commonjsGlobal.SPATH=`https://localhost:${n}`,commonjsGlobal.securePort=n),{secureApp:c,app:l,listen:()=>{i.forEach(e=>e())},close:()=>{c&&c.close&&c.close(),l&&l.close&&l.close()}}};function loadTests(e,r,t,o){loaddir({dir:e,onFile:e=>{o.map(r=>e.indexOf(r)>=0).indexOf(!0)>=0&&e.match(t)&&r.addFile(e)}})}async function runCommands(e){if(e)if(Array.isArray(e))for(let r=0;r<e.length;r++)await exec_1(e[r]).catch(commonjsGlobal.console.error);else await exec_1(e).catch(commonjsGlobal.console.error)}async function runTests(e={}){if(Array.isArray(e)){for(let r=0;r<e.length;r++)await runCommands(e[r].preCommand),delete e[r].preCommand;return parallel(e)}const{root:r=path.resolve("./"),serverOnly:t=!1,runUnitTests:o=!0,runBrowserTests:s=!0,coverage:n=!1,setGlobals:i=!0,testFileRegex:a=/\.test\.js$/,sourceFileRegex:l=/\.js$/,filters:c=[""],folders:u={},preCommand:p=!1,port:m="random",securePort:d=!1,useJunitReporter:f=!1,junitXmlFile:g=path.join(r,`./test-results/${path.basename(r)}/results.xml`),inspect:h=!1,reporters:_=["html"],mochaOptions:v={}}=e;h&&inspector.open(void 0,void 0,!0);const b=deepmerge({unitTest:path.join(r,"./test/unit"),browserTest:path.join(r,"./test/browser"),public:path.join(r,"./test/public"),static:[],coverage:path.join(r,"./.nyc_output"),source:path.join(r,"./src")},u,!0);if(n&&!commonjsGlobal.__s_dev_cov){const{createInstrumenter:e}=istanbulLibInstrument,r=e(),{hookRequire:t}=istanbulLibHook;t(e=>e.indexOf(b.source)>-1&&e.match(l),(e,{filename:t})=>r.instrumentSync(e,t)),commonjsGlobal.__s_dev_cov=!0}await runCommands(p);const w=await server(b.public,{extraStaticFolders:b.static,setGlobals:i,coverage:n,port:m,securePort:d});if(t)return w.listen(),"server";i&&testglobals(e),f&&(v.reporter="mocha-junit-reporter",v.reporterOptions={mochaFile:g});const y=new mocha(v);return!s&&o||!fs.existsSync(b.browserTest)||(w.listen(),await loadbrowser(r,n,b.coverage),loadTests(b.browserTest,y,a,c)),!o&&s||!fs.existsSync(b.unitTest)||loadTests(b.unitTest,y,a,c),new Promise((e,r)=>{y.run(async t=>{if(w.close(),commonjsGlobal.browser&&(await browser.close(),delete commonjsGlobal.browser,delete commonjsGlobal.page),n&&(writecoverage(commonjsGlobal.__coverage__,b.coverage,"unit-coverage"),transformcoverage(b.coverage,b.source,l,_)),t)return r(t);e(0)})})}process.on("message",async e=>{const r="function"==typeof(e=jsonFn.parse(e)).before&&e.before();r instanceof Promise&&await r,await runTests(e).catch(e=>{Number(e)?process.send(`${e}`):process.stderr.write(e+"\n")}).then(e=>{"server"!==e&&process.exit()})});var run=runTests,objectselect=(e,r=[])=>{const t={};return r.forEach(r=>{e[r]&&(t[r]=e[r])}),t},sifrr_dev={eslintrc:eslintrc,loadDir:loaddir,deepMerge:deepmerge,getRollupConfig:getrollupconfig,generateChangelog:generatechangelog,exec:exec_1,checkTag:checktag,releaseTag:releasetag,gitAddCommitPush:gitaddcommitpush,runTests:run,objectSelect:objectselect},sifrr_dev_1=sifrr_dev.eslintrc,sifrr_dev_2=sifrr_dev.loadDir,sifrr_dev_3=sifrr_dev.deepMerge,sifrr_dev_4=sifrr_dev.getRollupConfig,sifrr_dev_5=sifrr_dev.generateChangelog,sifrr_dev_6=sifrr_dev.exec,sifrr_dev_7=sifrr_dev.checkTag,sifrr_dev_8=sifrr_dev.releaseTag,sifrr_dev_9=sifrr_dev.gitAddCommitPush,sifrr_dev_10=sifrr_dev.runTests,sifrr_dev_11=sifrr_dev.objectSelect;exports.checkTag=sifrr_dev_7,exports.deepMerge=sifrr_dev_3,exports.default=sifrr_dev,exports.eslintrc=sifrr_dev_1,exports.exec=sifrr_dev_6,exports.generateChangelog=sifrr_dev_5,exports.getRollupConfig=sifrr_dev_4,exports.gitAddCommitPush=sifrr_dev_9,exports.loadDir=sifrr_dev_2,exports.objectSelect=sifrr_dev_11,exports.releaseTag=sifrr_dev_8,exports.runTests=sifrr_dev_10;
/*! (c) @aadityataparia */
